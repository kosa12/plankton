# Pre-commit hooks for code quality enforcement
# Install: uv add --dev pre-commit && uv run pre-commit install
# Run: uv run pre-commit run --all-files

repos:
  - repo: local
    hooks:
      # === PHASE 1: FORMATTING ===
      - id: ruff-format
        name: ruff (format)
        entry: uv run ruff format --force-exclude
        language: system
        types: [python]

      # === PHASE 2: LINTING ===
      - id: ruff-check
        name: ruff (lint)
        entry: uv run ruff check --fix --force-exclude
        language: system
        types: [python]

      # === PHASE 1a: TS FORMATTING ===
      - id: biome-format
        name: biome (format)
        entry: bash -c 'command -v biome >/dev/null 2>&1 || exit 0; biome format --write "$@"' --
        language: system
        files: \.(jsx?|tsx?|cjs|cts|mjs|mts|css)$

      # === PHASE 2a: TS LINTING ===
      - id: biome-lint
        name: biome (lint)
        entry: bash -c 'command -v biome >/dev/null 2>&1 || exit 0; biome lint --write "$@"' --
        language: system
        files: \.(jsx?|tsx?|cjs|cts|mjs|mts|css)$

      # === PHASE 2b: ASYNC LINTING ===
      - id: flake8-async
        name: flake8-async (async patterns)
        entry: uv run flake8 --select=ASYNC
        language: system
        types: [python]
        exclude: ^(tests/|scripts/|docs/)

      # === PHASE 3: TYPE CHECKING ===
      - id: ty-check
        name: ty (types)
        entry: uv run ty check
        language: system
        types: [python]
        exclude: ^(scripts/|docs/|tests/)
        require_serial: true

  # === PHASE 4: SHELL (pinned binary â€” consistent across macOS/Linux) ===
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        types: [shell]

  - repo: local
    hooks:
      # === PHASE 5: YAML ===
      - id: yamllint
        name: yamllint
        entry: uv run yamllint -c .yamllint
        language: system
        types: [yaml]

      # === PHASE 6: JSON ===
      - id: check-json
        name: jaq (json syntax)
        entry: bash -c 'for f in "$@"; do jaq empty "$f" || exit 1; done' --
        language: system
        types: [json]

      # === PHASE 7: TOML ===
      - id: taplo-check
        name: taplo (toml)
        entry: taplo check
        language: system
        types: [toml]

      # === PHASE 8: DOCKERFILE ===
      - id: hadolint
        name: hadolint
        entry: hadolint
        language: system
        files: (^|/)Dockerfile(\..*)?$|\.dockerfile$

      # === PHASE 8a: GITHUB ACTIONS SCHEMA ===
      - id: check-jsonschema-github-workflows
        name: check-jsonschema (GitHub Workflows)
        entry: uv run check-jsonschema --builtin-schema github-workflows
        language: system
        files: ^\.github/workflows/.*\.ya?ml$

      # === PHASE 8b: ACTIONLINT ===
      - id: actionlint
        name: actionlint
        entry: actionlint
        language: system
        files: ^\.github/workflows/.*\.ya?ml$

      # === PHASE 9: MARKDOWN ===
      - id: markdownlint
        name: markdownlint
        entry: markdownlint-cli2
        language: system
        pass_filenames: false
        verbose: true

      # === PHASE 10: DUPLICATES ===
      - id: jscpd
        name: jscpd (duplicates)
        entry: npx jscpd --config .jscpd.json --threshold 5
        language: system
        files: \.(py|sh|yaml|yml|ts|tsx|js|jsx|mjs|cjs|css)$
        pass_filenames: false
        stages: [pre-commit]
        verbose: true

# === INTENTIONAL EXCLUSIONS ===
# The following tools run in CC hooks and/or CI but NOT in pre-commit:
# - vulture: High false positive rate, advisory-only (needs whitelist)
# - bandit: Security scanning belongs in CI gates, not commit-time
# - flake8-pydantic: Niche Pydantic feedback, real-time via CC hooks
# - semgrep: Session-scoped security scanning, 5-15s with --config auto
# - knip: Project-scoped dead code analysis, 10-60s too slow for commit
# - oxlint+tsgolint: Per-file type-aware lint, opt-in in CC hooks only
# - tsgo: Session-scoped type checking advisory, opt-in in CC hooks only
